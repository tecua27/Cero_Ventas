<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - Carga de Datos ExpertCell</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .admin-card { background: #1e293b; padding: 3rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; border: 1px solid #334155; max-width: 500px; }
        .drop-zone { border: 2px dashed #3b82f6; padding: 2rem; border-radius: 15px; cursor: pointer; transition: 0.3s; margin: 20px 0; }
        .drop-zone:hover { background: #0f172a; border-color: #60a5fa; }
        .btn-link { color: #60a5fa; text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="admin-card">
    <h2 class="fw-bold mb-2">Panel de Administraci√≥n</h2>
    <p class="text-muted small">Sube el reporte de ventas para actualizar el Dashboard</p>
    
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <div class="display-4 mb-2">üìÅ</div>
        <p id="fileName">Haz clic para seleccionar el Excel</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none">
    </div>

    <div id="status"></div>
    
    <div class="mt-4">
        <button class="btn btn-danger btn-sm" onclick="clearSystem()">Limpiar Datos</button>
        <br><br>
        <a href="dashboard.html" target="_blank" class="btn-link">Ir al Dashboard de Visualizaci√≥n ‚Üí</a>
    </div>
</div>

<script>
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('fileName').innerText = file.name;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const hoy = new Date();

            const processed = json.map(row => {
                const getVal = (key) => {
                    const found = Object.keys(row).find(k => k.trim().toLowerCase().includes(key.toLowerCase()));
                    return row[found];
                };
                const fIngreso = parseDate(getVal('Fecha Ingreso'));
                const dias = fIngreso ? Math.floor((hoy - fIngreso) / (1000*60*60*24)) : 999;
                const v = parseInt(getVal('LOGRO EJECUTIVO')) || 0;
                let p = parseFloat(getVal('Porcentaje Logro')) || 0;
                if (p <= 1.2 && p > 0) p *= 100;

                return {
                    reg: getVal('Region') || "S/R",
                    tienda: getVal('Tienda') || "S/T",
                    nombre: getVal('Nombre Completo') || "Desconocido",
                    ventas: v,
                    logro: parseFloat(p.toFixed(1)),
                    fechaStr: fIngreso ? fIngreso.toLocaleDateString() : '---',
                    esNuevo: dias <= 30
                };
            });

            // GUARDAR EN LOCALSTORAGE
            localStorage.setItem('expertcell_data', JSON.stringify(processed));
            document.getElementById('status').innerHTML = '<div class="alert alert-success py-2 mt-3 small">‚úÖ Datos actualizados y sincronizados</div>';
        };
        reader.readAsArrayBuffer(file);
    };

    function parseDate(v) {
        if (!v) return null;
        if (!isNaN(v)) return new Date((v - 25569) * 86400 * 1000);
        return new Date(v);
    }

    function clearSystem() {
        if(confirm('¬øSeguro que quieres borrar los datos del dashboard?')) {
            localStorage.removeItem('expertcell_data');
            location.reload();
        }
    }
</script>
</body>
</html>