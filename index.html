<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard VisualizaciÃ³n - ExpertCell</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-width: 280px; --primary-dark: #0f172a; --accent-blue: #3b82f6; --danger-soft: #fef2f2; --danger-bold: #ef4444; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: var(--primary-dark); color: white; padding: 2rem 1.2rem; z-index: 100; }
        .main-content { margin-left: var(--sidebar-width); padding: 2.5rem; }
        .kpi-card { border: none; border-radius: 12px; padding: 1.2rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .kpi-title { color: #64748b; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .kpi-value { font-size: 1.75rem; font-weight: 800; margin-top: 0.3rem; }
        .glass-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .badge-new { background: #fef3c7; color: #92400e; padding: 3px 7px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; }
        .alert-row { background-color: var(--danger-soft) !important; color: var(--danger-bold); }
        .scrollable { max-height: 400px; overflow-y: auto; }
        /* Estilo para los encabezados de tabla fijos */
        .table thead th { position: sticky; top: 0; background: #fff; z-index: 5; border-bottom: 2px solid #f1f5f9; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="text-center mb-5">
        <h5 class="fw-bold tracking-tight">EXPERTCELL</h5>
        <div class="badge bg-primary px-3 small">Dashboard en Vivo</div>
    </div>
    <div id="filterControls">
        <label class="form-label small fw-bold text-muted">REGIÃ“N</label>
        <select id="selRegion" class="form-select bg-dark text-white border-0 mb-4" onchange="actualizarTiendas()"></select>
        <label class="form-label small fw-bold text-muted">TIENDA</label>
        <select id="selTienda" class="form-select bg-dark text-white border-0" onchange="renderizar()"></select>
    </div>
</div>

<div class="main-content">
    <div id="noData" class="text-center py-5 mt-5">
        <h2 class="text-muted">Esperando datos del administrador...</h2>
    </div>

    <div id="content" style="display:none">
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="kpi-card border-start border-primary border-4"><div class="kpi-title">Ejecutivos</div><div class="kpi-value" id="kpiTotal">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-danger border-4"><div class="kpi-title text-danger">Cero Ventas</div><div class="kpi-value text-danger" id="kpiCeros">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-warning border-4"><div class="kpi-title text-warning">Logro < 60%</div><div class="kpi-value text-warning" id="kpiBajos">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-info border-4"><div class="kpi-title text-info">Nuevos</div><div class="kpi-value text-info" id="kpiNuevos">0</div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="glass-card">
                    <h6 class="fw-bold text-danger mb-3">ðŸš¨ Alerta: Sin Ventas Registradas</h6>
                    <div class="scrollable">
                        <table class="table table-sm align-middle">
                            <thead class="small text-muted">
                                <tr>
                                    <th>NOMBRE</th>
                                    <th>TIENDA</th>
                                    <th class="text-end">INGRESO</th>
                                </tr>
                            </thead>
                            <tbody id="listaCeros" class="small"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="glass-card">
                    <h6 class="fw-bold text-primary mb-3">Ranking de DesempeÃ±o</h6>
                    <div class="scrollable">
                        <table class="table table-hover table-sm align-middle">
                            <thead class="small text-muted">
                                <tr class="text-center">
                                    <th class="text-start">NOMBRE</th>
                                    <th>VENTAS</th>
                                    <th>LOGRO</th>
                                    <th>ESTADO</th>
                                </tr>
                            </thead>
                            <tbody id="listaGeneral" class="small"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="glass-card">
                    <div style="height: 450px;"><canvas id="mainChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let myChart = null;

    function loadData() {
        const data = localStorage.getItem('expertcell_data');
        if (data) {
            rawData = JSON.parse(data);
            document.getElementById('noData').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            initFilters();
        } else {
            document.getElementById('noData').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }
    }

    // ACTUALIZACIÃ“N AUTOMÃTICA
    window.addEventListener('storage', (e) => {
        if (e.key === 'expertcell_data') loadData();
    });

    function initFilters() {
        const regs = ['TODAS', ...new Set(rawData.map(d => d.reg))];
        document.getElementById('selRegion').innerHTML = regs.map(r => `<option value="${r}">${r}</option>`).join('');
        actualizarTiendas();
    }

    function actualizarTiendas() {
        const r = document.getElementById('selRegion').value;
        const filtered = r === 'TODAS' ? rawData : rawData.filter(d => d.reg === r);
        const tiendas = ['TODAS', ...new Set(filtered.map(d => d.tienda))];
        document.getElementById('selTienda').innerHTML = tiendas.map(t => `<option value="${t}">${t}</option>`).join('');
        renderizar();
    }

    function renderizar() {
        const r = document.getElementById('selRegion').value;
        const t = document.getElementById('selTienda').value;
        const data = rawData.filter(d => (r === 'TODAS' || d.reg === r) && (t === 'TODAS' || d.tienda === t));
        data.sort((a, b) => a.logro - b.logro);

        document.getElementById('kpiTotal').innerText = data.length;
        document.getElementById('kpiCeros').innerText = data.filter(d => d.ventas === 0).length;
        document.getElementById('kpiBajos').innerText = data.filter(d => d.logro < 60 && d.ventas > 0).length;
        document.getElementById('kpiNuevos').innerText = data.filter(d => d.esNuevo).length;

        // RENDERIZAR TABLA SIN VENTAS CON 3 COLUMNAS
        const ceros = data.filter(d => d.ventas === 0);
        document.getElementById('listaCeros').innerHTML = ceros.map(d => `
            <tr class="alert-row">
                <td class="fw-bold">${d.nombre}</td>
                <td>${d.tienda}</td>
                <td class="text-end text-muted">${d.fechaStr}</td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="text-center py-4 text-muted">Sin ejecutivos en esta categorÃ­a</td></tr>';
        
        // RENDERIZAR RANKING GENERAL
        document.getElementById('listaGeneral').innerHTML = data.map(d => `
            <tr class="text-center">
                <td class="text-start">
                    <div class="fw-bold">${d.nombre}</div>
                    <div class="text-muted" style="font-size:0.7rem">${d.tienda}</div>
                </td>
                <td class="fw-bold">${d.ventas}</td>
                <td class="${d.logro < 60 ? 'text-danger fw-bold' : ''}">${d.logro}%</td>
                <td>${d.esNuevo ? '<span class="badge-new">NUEVO</span>' : '<span class="text-muted" style="font-size:0.7rem">PLANTA</span>'}</td>
            </tr>
        `).join('');

        // GRÃFICO
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: {
                labels: data.map(d => d.nombre),
                datasets: [
                    { type: 'bar', label: 'Ventas', data: data.map(d => d.ventas), backgroundColor: data.map(d => d.ventas === 0 ? '#ef4444' : (d.esNuevo ? '#f59e0b' : '#3b82f6')), yAxisID: 'y', borderRadius: 5 },
                    { type: 'line', label: '% Logro', data: data.map(d => d.logro), borderColor: '#0f172a', borderWidth: 2, yAxisID: 'y1', tension: 0.2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left', title: {display: true, text: 'Unidades'} }, y1: { position: 'right', min: 0, max: 130, title: {display: true, text: 'Logro %'}, grid: {drawOnChartArea: false} } } }
        });
    }

    window.onload = loadData;
</script>
</body>
</html>