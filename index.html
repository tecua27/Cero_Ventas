<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ExpertCell - Dashboard PÃºblico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-width: 280px; --primary-dark: #0f172a; --accent-blue: #3b82f6; }
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; background: var(--primary-dark); color: white; padding: 2rem 1.2rem; z-index: 100; }
        .main-content { margin-left: var(--sidebar-width); padding: 2.5rem; }
        .kpi-card { border: none; border-radius: 12px; padding: 1.2rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .glass-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 1.5rem; margin-bottom: 2rem; }
        .badge-new { background: #fef3c7; color: #92400e; padding: 3px 7px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; }
        .scrollable { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="text-center mb-5">
        <h5 class="fw-bold">EXPERTCELL</h5>
        <div class="badge bg-primary">Dashboard PÃºblico</div>
    </div>
    <div id="filterControls">
        <label class="form-label small fw-bold text-muted">REGIÃ“N</label>
        <select id="selRegion" class="form-select bg-dark text-white border-0 mb-4" onchange="actualizarTiendas()"></select>
        <label class="form-label small fw-bold text-muted">TIENDA</label>
        <select id="selTienda" class="form-select bg-dark text-white border-0" onchange="renderizar()"></select>
    </div>
</div>

<div class="main-content">
    <div id="loading" class="text-center py-5"><h3 class="text-muted">Cargando informaciÃ³n...</h3></div>

    <div id="content" style="display:none">
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="kpi-card border-start border-primary border-4"><div class="text-muted small">EJECUTIVOS</div><div class="h4 fw-bold" id="kpiTotal">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-danger border-4"><div class="text-danger small">CERO VENTAS</div><div class="h4 fw-bold text-danger" id="kpiCeros">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-warning border-4"><div class="text-warning small">BAJO LOGRO</div><div class="h4 fw-bold text-warning" id="kpiBajos">0</div></div></div>
            <div class="col-md-3"><div class="kpi-card border-start border-info border-4"><div class="text-info small">NUEVOS</div><div class="h4 fw-bold text-info" id="kpiNuevos">0</div></div></div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="glass-card">
                    <h6 class="fw-bold text-danger mb-3">ðŸš¨ Alerta: Sin Ventas</h6>
                    <div class="scrollable"><table class="table table-sm small"><thead class="text-muted"><tr><th>NOMBRE</th><th>TIENDA</th><th>INGRESO</th></tr></thead><tbody id="listaCeros"></tbody></table></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="glass-card">
                    <h6 class="fw-bold text-primary mb-3">Ranking Detallado</h6>
                    <div class="scrollable"><table class="table table-hover table-sm small align-middle"><thead class="text-muted"><tr><th>NOMBRE</th><th>VENTAS</th><th>LOGRO</th><th>ESTADO</th></tr></thead><tbody id="listaGeneral"></tbody></table></div>
                </div>
            </div>
        </div>
        <div class="row"><div class="col-12"><div class="glass-card"><canvas id="mainChart" height="400"></canvas></div></div></div>
    </div>
</div>

<script>
    let rawData = [];
    let myChart = null;

    // CARGA DESDE EL ARCHIVO JSON EXTERNO
    async function fetchData() {
        try {
            const response = await fetch('datos.json');
            rawData = await response.json();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            initFilters();
        } catch (error) {
            document.getElementById('loading').innerHTML = '<h3 class="text-danger">Error al cargar datos.json</h3>';
        }
    }

    function initFilters() {
        const regs = ['TODAS', ...new Set(rawData.map(d => d.reg))];
        document.getElementById('selRegion').innerHTML = regs.map(r => `<option value="${r}">${r}</option>`).join('');
        actualizarTiendas();
    }

    function actualizarTiendas() {
        const r = document.getElementById('selRegion').value;
        const filtered = r === 'TODAS' ? rawData : rawData.filter(d => d.reg === r);
        const tiendas = ['TODAS', ...new Set(filtered.map(d => d.tienda))];
        document.getElementById('selTienda').innerHTML = tiendas.map(t => `<option value="${t}">${t}</option>`).join('');
        renderizar();
    }

    function renderizar() {
        const r = document.getElementById('selRegion').value;
        const t = document.getElementById('selTienda').value;
        const data = rawData.filter(d => (r === 'TODAS' || d.reg === r) && (t === 'TODAS' || d.tienda === t));
        data.sort((a, b) => a.logro - b.logro);

        document.getElementById('kpiTotal').innerText = data.length;
        document.getElementById('kpiCeros').innerText = data.filter(d => d.ventas === 0).length;
        document.getElementById('kpiBajos').innerText = data.filter(d => d.logro < 60 && d.ventas > 0).length;
        document.getElementById('kpiNuevos').innerText = data.filter(d => d.esNuevo).length;

        document.getElementById('listaCeros').innerHTML = data.filter(d => d.ventas === 0).map(d => `
            <tr class="table-danger"><td>${d.nombre}</td><td>${d.tienda}</td><td>${d.fechaStr}</td></tr>
        `).join('') || '<tr><td colspan="3" class="text-center">Sin incidencias</td></tr>';
        
        document.getElementById('listaGeneral').innerHTML = data.map(d => `
            <tr><td><b>${d.nombre}</b><br><small>${d.tienda}</small></td><td class="text-center">${d.ventas}</td>
            <td class="text-center ${d.logro < 60 ? 'text-danger fw-bold' : ''}">${d.logro}%</td>
            <td class="text-center">${d.esNuevo ? '<span class="badge-new">NUEVO</span>' : ''}</td></tr>
        `).join('');

        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: {
                labels: data.map(d => d.nombre),
                datasets: [
                    { type: 'bar', label: 'Ventas', data: data.map(d => d.ventas), backgroundColor: data.map(d => d.ventas === 0 ? '#ef4444' : (d.esNuevo ? '#f59e0b' : '#3b82f6')), yAxisID: 'y' },
                    { type: 'line', label: '% Logro', data: data.map(d => d.logro), borderColor: '#0f172a', borderWidth: 2, yAxisID: 'y1', tension: 0.2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left' }, y1: { position: 'right', min: 0, max: 130 } } }
        });
    }

    window.onload = fetchData;
</script>
</body>
</html>